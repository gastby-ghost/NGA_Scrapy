# NGA_Scrapy 动态代理使用指南

## 概述

本项目已集成动态代理功能，支持从巨量IP API获取代理并在爬虫中使用。代理功能可以帮助：
- 避免同一IP频繁访问被封禁
- 提高爬取成功率
- 降低被反爬系统检测的概率

## 使用前准备

### 1. 获取巨量IP代理服务

1. 访问 [巨量IP官网](https://www.juliangip.com/) 注册账号
2. 购买动态代理产品
3. 在会员中心的[动态代理产品管理](https://www.juliangip.com/users/product/time)页面
   - 生成提取链接
   - 获取**业务编号（trade_no）**和**API Key**
   - **重要**：在订单设置中添加当前服务器的IP地址（否则无法获取IP）

### 2. 配置代理参数

1. 复制配置模板：
   ```bash
   cp proxy_config.json.template proxy_config.json
   ```

2. 编辑 `proxy_config.json` 文件，填入真实的参数：
   ```json
   {
     "trade_no": "你的业务编号",
     "api_key": "你的API密钥",
     "api_url": "http://v2.api.juliangip.com/dynamic/getips",
     "num": 10,
     "pt": 1,
     "result_type": "json",
     "min_proxies": 5,
     "get_interval": 60
   }
   ```

3. 参数说明：
   - `trade_no`: 业务编号（必填）
   - `api_key`: API密钥（必填）
   - `api_url`: API地址（可选，默认为巨量IP地址）
   - `num`: 单次提取数量（可选，默认10，最大100）
   - `pt`: 代理类型（可选，1=HTTP代理，默认1）
   - `result_type`: 返回格式（可选，json/text/xml，默认json）
   - `min_proxies`: 最小代理池数量（可选，默认5）
   - `get_interval`: 获取代理的最小间隔（秒）（可选，默认60）

### 3. 启用代理功能

编辑 `NGA_Scrapy/settings.py` 文件，将：
```python
'PROXY_ENABLED': False,
```

修改为：
```python
'PROXY_ENABLED': True,
```

## 使用方法

### 运行爬虫

启用代理后，运行爬虫时会自动使用代理：

```bash
# 激活虚拟环境
source venv/bin/activate

# 运行爬虫
scrapy crawl nga
```

### 查看代理状态

爬虫启动后，会在日志中看到类似信息：
```
INFO: 代理管理器已初始化
INFO: 成功加载 10 个代理
INFO: 使用代理: 119.112.92.233:38727
```

每小时的统计报告中也会包含代理池状态：
```
INFO: 代理池状态:
{
  "total_proxies": 10,
  "used_proxies": 3,
  "available_proxies": 7,
  "last_fetch_time": "2025-11-30 15:30:00",
  "needs_refresh": false
}
```

## 代理池管理

### 自动轮换

- 系统会自动轮换使用代理池中的代理
- 当代理失败时，会自动从代理池中移除
- 当代理池数量低于阈值时，会自动获取新代理

### 手动刷新代理

如果需要手动刷新代理池，可以通过修改代码调用：
```python
from NGA_Scrapy.utils.proxy_manager import get_proxy_manager

proxy_manager = get_proxy_manager()
proxy_manager.get_proxies(force_refresh=True)
```

### 查看代理池状态

```python
from NGA_Scrapy.utils.proxy_manager import get_proxy_manager

proxy_manager = get_proxy_manager()
status = proxy_manager.get_pool_status()
print(json.dumps(status, ensure_ascii=False, indent=2))
```

## 故障排除

### 1. 无法获取代理

**现象**：
```
ERROR: API返回错误: 签名校验失败，请参照开发文档修改或联系客服处理。
```

**解决方案**：
- 检查 `trade_no` 和 `api_key` 是否正确
- 确认已在巨量IP订单设置中添加服务器IP
- 检查API Key是否有效

### 2. 代理连接失败

**现象**：
```
WARNING: 代理 119.112.92.233:38727 标记为失败，已移除
```

**解决方案**：
- 系统会自动移除失败代理并获取新代理
- 如果持续失败，检查代理池数量是否充足
- 调整 `min_proxies` 参数增加初始代理数量

### 3. 代理速度慢

**解决方案**：
- 在巨量IP后台选择更优质的代理线路
- 减少并发数（修改 `CONCURRENT_REQUESTS`）
- 增加请求间隔（修改 `DOWNLOAD_DELAY`）

## 注意事项

1. **IP白名单**：必须在巨量IP订单设置中添加服务器IP，否则无法获取代理
2. **请求频率**：巨量IP API限制10次/秒，系统默认60秒间隔获取，无需手动调整
3. **成本控制**：代理按使用量计费，请根据实际需求调整 `num` 参数
4. **代理质量**：建议选择HTTP代理（pt=1），SOCK代理可能存在兼容性问题
5. **地区选择**：可在巨量IP后台设置提取地区，减少网络延迟

## 禁用代理

如需禁用代理：

1. 编辑 `NGA_Scrapy/settings.py`：
   ```python
   'PROXY_ENABLED': False,
   ```

2. 重新运行爬虫即可使用直连

## 技术实现

代理功能通过以下模块实现：

- **代理管理器**：`NGA_Scrapy/utils/proxy_manager.py`
  - 调用巨量IP API
  - 管理代理池
  - 代理轮换和失败处理

- **中间件集成**：`NGA_Scrapy/middlewares.py`
  - PlaywrightMiddleware 集成代理功能
  - 浏览器实例自动使用代理

- **配置管理**：`NGA_Scrapy/settings.py`
  - 代理开关和参数配置
